worker_processes  1;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;

    upstream element_web {
        server matrix_element:80;
    }

    upstream synapse {
        server matrix_synapse:8008;
    }

    # 1) Front door: matrix.chat
    server {
        listen 80;
        server_name matrix.chat;

        root /usr/share/nginx/html;
        index index.html;

        # static landing page and downloads are served directly from /usr/share/nginx/html
    }

    # 2) Element Web: web.matrix.chat
    server {
        listen 80;
        server_name web.matrix.chat;

        location / {
            proxy_pass http://element_web/;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $remote_addr;
        }
    }

    # 3) Synapse API: synapse.matrix.chat
    server {
        listen 80;
        server_name synapse.matrix.chat;

        location /_matrix/ {
            proxy_pass http://synapse/_matrix/;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $remote_addr;
        }

        # Optional: health check
        location / {
            return 200 "Synapse API endpoint\n";
        }
    }
}
